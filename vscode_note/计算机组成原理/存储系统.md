# <center> 存储系统 <center/>

## 1. 存储器概述

一、基本概念

1. 定义：计算机中用来存放程序和数据的记忆设备。**主要分为两类：主存和辅存**。  
   1. 主存：Memory，一般称为内存。

   2. 辅存：Storage，一般称为外存。
   ```
   存储器在现代计算机体系结构中是中心地位，向CPU提供数据和指令。
   ```

2. 层次结构  
   1. 层次越高，容量越小速度越快成本越高；层次越低，容量越大速度越慢成本越低。

   2. 每一层只存放下一层的部分数据。

3. 基本术语  
   1. **存储位元/记忆单元/位元**：具有两种稳态的能够表示二进制操作数0和1物理部件。

   2. **存储单元**：简单来说就是一个**编址单位**。
   3. 编址方式：对存储单元进行编号的方式。
      ```
      如果提到按字节/字/双字编址，说明一个存储单元的大小为字节/字/双字。
      ```
   4. 存储体/存储矩阵/存储阵列：所有存储单元构成的一个存储阵列。
      ```
      存储位元、存储单元和存储体的关系是：若干个存储位元构成一个存储单元，若干个存储单元构成一个存储体。
      ```
   5. **机器字长**：运算器中参与运算的寄存器位数，**等同于数据通路的宽度**。
   6. **存储字长**：存储芯片中一个读写单位，**等同于存储器的数据线宽度**。

二、存储器的分类

1. 按作用分类：

   | 用途 | 寄存器型存储器            | 高速缓冲存储器                           | 主存储器            | 辅存、外存                      | 其他                                     |
   |:------:|:---------------------------:|:------------------------------------------:|:---------------------:|:---------------------------------:|:------------------------------------------:|
   | 特点 | 由寄存器构成，集成在CPU内 | 集成在CPU内或者在CPU和主存之间<br>用SRAM实现 | 在CPU外部用DRAM实现 | 就是俗称的硬盘<br>CPU没法直接访问 | 控存CM、表格存储器<br>字库和缓冲存储器等。 |

2. 按存储介质分类

   | 存储介质 | 半导体存储器SCM                            | 磁表面存储器MSM                | 光盘存储器ODM              | 铁电存储器、相变存储器、阻变存储器等 |
   |:----------:|:--------------------------------------------:|:--------------------------------:|:----------------------------:|:--------------------------------------:|
   | 特点     | 速度快，用作内存<br>原理：双稳态触发器、电容 | 非易失，用作外存、容量大价格低 | 非易失，保存时间长，容量大 | 掉电数据不丢失，容量大               |

3. 按存取方式分类

   | 存储方式 | 随机访问存储器RAM                  | 只读存储器ROM        | 相连存储器CAM                                    | 直接存取存储器DAS                                              | 顺序存储器SAM                                                   |
   |:----------:|:------------------------------------:|:----------------------:|:--------------------------------------------------:|:---------------------------------------:|:-------------------------------------:|
   | 特点     | 用于主存和Cache 访问特点类似于数组 | 只读，不支持随机读写 | 用于快表 按内容检索到位置进行读写 速度快、价格高 | 用于磁盘 介于随机存储和顺序存储之间 存取时间与数据所在位置有关 | 用于磁带、VCD 存取时间与数据所在位置有关 速度慢、容量大、成本低 |

   ```
   只读存储器还可以细分为以下几种：MROM，只读、PROM，一次写、EPROM，EEPROM、UVPROM：多次改写
   ```

   > 判断：半导体存储器都采用随机存取方式进行读写。
   > 
   > [解答]：错。有些半导体存储器可以按内容访问，比如全相连映射的Cache就是按内容（标志信息Tag）访问的。

4. 按信息的可保存性分类
   1. 断电后是否丢失数据
      - **易失性存储器**(挥发性存储器)：断电后信息丢失。主要**有DRAM和SRAM**。

      - **非易失性存储器**(非挥发性存储器)：断电后信息不丢失。主要**有ROM、磁盘和闪存**。

   2. 读出后是否保持数据
      - **破坏性存储器**：读出以后信息损坏，需要刷新。主要**有DRAM**。

      - **非破坏性存储器**：读出以后信息不损坏。主要**有SRAM**。

三、性能指标

1. 存储容量：**存储容量 = 存储字数 $\times$ 字长**。
   1. **单位换算**
      - 1字节 = 1B

      - 1字 = 4B、半字 = 2B、双字 = 8B
      - 1B = 8bit = 8位

   2. **存储字数就是存储器的地址空间大小**。

2. 存储速度：**数据传速率 = 数据的宽度/存储周期**。
   1. 存取时间：从启动一次存储器操作到完成该操作所经历的时间。
   2. 存取周期：存储器进行一次完整的读写操作所需的全部时间。宏观来看存取时间包含在存取周期内。

   3. 主存带宽(数据传输率)：每秒从主存进出信息的最大数量。

## 2. 半导体存储器(RAM和ROM)

一、RAM

1. RAM的分类
   1. 双极RAM：集成度低，功耗大、速度快。双极RAM不复用地址线和数据线。

   2. SRAM：集成度介于二者之间。SRAM复用数据线。
   3. DRAM：集成度高，功耗小，速度慢。**DRAM复用数据线和地址线，即地址线数和数据线数是原来的一半**。
      ```
      当行列数不一样时，地址线数（地址引脚数）为log2(max(行，列))。
      ```   

2. DRAM的刷新
   1. 有三种刷新方式：**集中刷新、分散刷新、异步刷新**。详细描述见下表。

      | 刷新方式 | 集中刷新                                                | 分散刷新                                      | 异步刷新(透明刷新)                    |
      |:----------:|:----------:|:---------:|:--------------:|
      | 原理     | 使用一块固定的时间进行刷新<br>刷新期间停止读写 | 将一个存储周期分为两段<br>即前半周期正常读写，后半周期刷新            | 每隔一段时间t提交一次刷新请求         |
      | 优缺点   | 优点：刷新不影响读写操作<br>缺点：位于死区时不能访问存储器 | 优点：没有死区<br>缺点：延长了存取周期，降低速度 | 优点：避免CPU长时间等待，减少刷新次数 |

   2. 特点：
      - **DRAM的刷新单位是行**。

      - 刷新对CPU透明。
      - 刷新类似于读操作，但是不需要信息输出。
   3. 按操作控制方式分类，亦有三种刷新方式：**同步刷新、异步刷新半同步刷新**。

3. SRAM和DRAM的比较

   |       | 应用      | 存储元 | 地址线      | 是否刷新  | 是否易失  | 是否破坏性读出  |  是否对电干扰敏感  |
   |:------:|:----------:|:--------------:|:------------:|:----------:|:----------:|:----------------:|:-------------:|
   | SRAM  | 高速缓存  | 双稳态触发器(六管静态MOS电路)  | 直接送地址  | 否        | 是        | 否              |  否           |
   | DRAM  | 主存      | 栅极电容      | 地址复用    | 是        | 是        | 是              |   是             |

   > 判断：系统的主存都采用DRAM芯片实现。
   > 
   > [解答]：错。PC系统的主存由RAM区和ROM区组成。其中RAM区一般由DRAM芯片实现，ROM区使用相应的ROM存储元件实现。也就是说并不是所有系统的内存都是由DRAM实现的。

二、ROM


1. 特点

   1. 非易失、不用刷新、高位密度、掉电不丢失信息。

   2. 按地址寻址，只能随机读而不能随机写，但是仍以随机存取方式工作。
   3. 区分："支持随机存取的存储器"和"随机存取存储器"。

2. 分类：大致分为两类
   1. 不可修改的ROM,常用作BIOS

   2. 可读写的ROM(闪存)，常用作主存拓展、U盘等。
3. 细分：

      |   ROM  |               固定掩模ROM(MROM)               |        一次可改写ROM(PROM)       |               多次可改写ROM(EPROM)              |                     Flash                     |
      |:------:|:---------------------------------------------:|:--------------------------------:|:-----------------------------------------------:|:---------------------------------------------:|
      |  特点  |     在生产过程中直接写入 一旦写入无法修改     | 可以写入一次 以熔断丝型ROM为主流 | 改写之前需要擦除所有单元 包括UVPROM、EEPROM、FM |        不加电也能长期保存信息 常见于U盘       |
      | 优缺点 | 优点：集成度高、可靠性高、便宜 缺点：灵活性差 |                 -                |         缺点：编程次数有限，写入时间过长        | 优点：价格便宜、集成度高、 可擦除重写且速度快 |

## 3. 主存设计

一、 主存容量的扩展

1. 拓展方法：**字拓展、位拓展、字位同时拓展**
   1. 字拓展：位数不变，容量拓展。

   2. 位拓展：字数(存储单元数、存储容量)不变，位数拓展。
   3. 字位同时拓展：容量和位数同时增加

2. 理解：
   1. 位拓展就相当于并联。比如一个芯片能提供4位数据，两个芯片并在一起就能提供8位数据。

   2. 字拓展相当于串联，通过串联对芯片扩容。比如一个芯片是8K，4个芯片串在一起，就能寻址到32K，同时要添加两条片选信号确定当前地址所在芯片。

二、负载计算与负载分配

1. 负载驱动
   1. 外围电路芯片为驱动，存储芯片各端点就是负载。

   2. 双极型芯片各端点为**电流负载**；MOS型芯片各端点为**电容负载**。
   3. 负载因数：存储芯片**某种端点中**的**一个端点的负载量**。比如 $f_A$ 就是地址端的负载因数。

2. 负载计算
   1. 地址驱动线负载：$L_A = \lceil\cfrac{M}{m}\rceil\lceil\cfrac{N}{n}\rceil f_A$。
      ```
      其实就是字拓展倍数*位拓展倍数*一个地址端的负载因数。因为地址线要送到每片芯片里面。
      ```

   1. 读写控制驱动线负载：计算同地址驱动线。因为读写时要选择读写哪一片芯片，所以读写控制线也要连到每一片上。
   2. 行片选驱动负载：**位拓展倍数乘以行片选驱动端的位数**。
   3. 数据线输入输出负载：**字拓展倍数乘以一个输入输出端的负载因数**。
   4. 负载分载：由于逻辑电路的负载能力有限，如果到**达负载极限的话需要分载**。具体来说类似于多级页表的思路。
3. 速度估算
   1. 系统取数时间，主要分为以下两种情况：
      - 如果地址信号A最后到达芯片，系统地址取数时间 = 地址缓冲延时 + 存储芯片取址取数时间。

      - 如果CS信号CS最后到达芯片，系统片选取数时间 = 片选译码延迟 + 系统片选取数时间。

   2. 系统存储周期：芯片存储周期 + 系统传输延迟 + 系统恢复时间。
      - 芯片存储周期：由手册得到。

      - 系统传输时延：
      - 系统恢复时间：

三、杂项

1. CPU和存储器总线连接方式——**总线连接方式**
   1. 地址线：**CPU地址线数**决定**整个存储空间的寻址范围**，CPU地址线低位和存储芯片连接，高位用于**字拓展片选译码**。

   2. 数据线：**CPU数据线数**决定**一次可读写的最大的数据宽度**，CPU数据线直接连接到多个**位拓展**的存储芯片中。
   3. 控制线：**CPU读/写命令线**和**存储芯片读写控制线**是**同一根**且**电平信号相同**，则直接连接。否则分开连接。

2. CPU和主存的通信方式
   1. 异步方式：通过**握手信号**保证。

   2. 同步方式：CPU和主存读写由**统一的时钟信号**控制。
3. 主存空间划分(主存空间包括ROM区和RAM区)
   1. ROM区：系统程序、标准子程序等。

   2. RAM区：用户程序。
4. 补充知识点：
   1. 74ls138译码器：当一个选通端(G1)为高电平，另外两个选通端(G2、G3)为低电平时，可以将地址端(A、B、C)的**二进制编码**在一个对应的输出端以**低电平**进行输出。

   2. MREQ信号：低电平时访问主存。

## 4. 高速缓冲存储器Cache

一、 原理

   ```
   cache的原理即程序访问局部性。

   程序访问局部性产生的原因：1. 指令按序存放，地址连续；循环重复执行。2. 数据连续存放。比如数组元素重复、按序访问。
   ```

   1. 特点：对**程序员透明**(对程序员**不可见**)、由**SRAM**组成、集成在CPU内且**与CPU同速**。

   2. 划分：一般将Cache和主存的存储空间划分为若干大小相同的块，主存称块，Cache称行/槽/项/块。
   3. 性能指标：
      > 记号：cache访问时间：$T_c$、主存访问时间：$T_m$、命中率：$p$
      1. 命中时间：判断时间 + 访问cache时间。

      2. 失效（失靶、缺失）时间：访问主存时间 + 访问cache时间。
      3. 平均访问时间：$T_a = p\times T_c + (1-p)\times(T_m + T_c) = T_c + (1-p)\times T_m$。

二、 Cache和主存的映射

1. 映射方式

   1. 直接映射/模映射
      - **地址结构：[标记（主存块编号）] [Cache行号] [块内地址]**
         ```
         标记的作用可以理解为一个主存块对应到哪个cache块。
         ```

      - 关系：Cache行号 = 主存块号 mod Cache总行数。
      - 优缺点：易实现，命中时间短，淘汰替换策略简单；不灵活，无法有效利用Cache空间，命中率低。
      ```
      直接映射的关联度为1。
      ```

   2. 全相联映射
      - **地址结构：[标记（主存块编号）] [块内地址]**

      - 关系：Cache每一行都能放
      - 优缺点：块冲突概率低；实现复杂，速度慢，不适合大容量存储器。
      ```
      全相连映射的关联度为Cache行数。
      ```
   3. 组相联映射
      - **地址结构：[标记（主存块编号）] [组号] [块内地址]**

      - 关系：Cache组号 = 主存块号 mod Cache组数
      - n路组相连映射的关联度为n。

2. 替换策略：下表是在不同的映射方式下，不同的替换算法在cache中需要的控制替换位数。

   ||随机替换算法|LRU算法|FIFO算法|
   |:-:|:-----:|:----:|:-----:|
   |全相连映射|0|$log_2(行数)$|$log_2(行数)$|
   |组相连映射|0|$log_2(路数)$|$log_2(路数)$|

3. 写策略(Cache一致性)
   1. 写命中机制
      - Write Through(写直达、写直通、直写、全写法)：写命中时，**同时写Cache和主存**；为了减少时间损耗，还需要维护一个写缓冲队列

      - Write Back(写回、一次性写、回写)：写命中时，**只写入Cache**；当此块被换出时才写回主存；设置一个**脏位**，表示**是否被修改**。如果没被修改就不用写主存。

   2. 写不命中机制
      - Write Allocate(写分配)：加载主存的块到Cache中，然后更新该Cache块。缺点是增加了读一次主存块的开销。

      - Non Write Allocate(写不分配)：只写入主存，不调块。
   3. **写不分配法通常和全写法**一起使用，**写分配法通常和回写法**一起使用。

三、Cache性能分析

1. Cache性能：Cache性能由**失效率**确定，失效率与**Cache大小、块大小、映射方式、Cache级数**有关。
   1. Cache大小：
      - Cache越大，失效率越低，但是成本越高。 
      - 对小容量的Cache，以组相连为例，组相连路数越大，失效率越小。

      - 对较大容量的Cache，则几乎不变。
   2. Block大小： 
      - Block越大，失效率越低。

      - Block增大到一定程度时，失效率增加。

2. Cache失效类型：

   |      | 强制失效         | 容量失效                    | 冲突失效                        |
   |:------:|:-----:|:-------:|:----------------------:|
   | 失效原因 | 首次访问数据块时必然发生 | Cache不能存放所有块，导致替换后再次被使用 |  映射到同一组的Cache的块数目超过该组所能容纳的块 |
   | 解决方案 | 增加Block大小    | 增加Cache大小               | 全相连方式不会出现此类冲突               |

3. Cache抖动：某些块在主存和Cache之间反复多次的传送。解决方法：增大Cache容量和相连性。

四、多级Cache设计：
1. 片内/片外：Cache是放在CPU内部还是CPU外部？

2. 联合/分立：是否拆分为指令Cache和数据Cache？
   1. L1 Cache一般采用分立Cache。即数据和指令分开。这是因为**L1 Cache命中时间比命中率更重要**。

   2. L2、L3 Cache一般采用联合Cache。这是因为**L2、L3 Cache命中率比命中时间更重要**。
3. 单级/多级：现代CPU一般采用二级或者三级Cache，其中L1 Cache离CPU最近，速度最快。 

## 5. 存储层次

一、并行主存系统

1. 双端口存储器：一个存储器提供两套**独立工作**的读写控制电路、地址缓存、地址译码、两个读写端口。根据地址线和数据线**可以同时进行两个数据的读写**。

2. 多模块存储器(多体交叉)：包含多个小存储体/模块，每个体有自己的MAR、MDR和读写电路。**多个存储模块可以并行工作**。
   1. 连续编址(高位交叉访问)
      - **高位**表示存储体号，低位表示模块内地址。

      - 地址连续的数据放在同一存储体内，容易出现冲突。简单来说就是想要并行访问n个地址，但是这n个地址大概率是落在同一个存储体内。这样就冲突了。

   2. 交叉编址(低位交叉访问)
      - **低位**表示存储体号，高位表示模块内地址。

      - **以存储体个数为模交叉编址**。
      - 多个存储体存放地址连续的数据。如果需要并行访问n个地址，这n个地址平均的落在四个存储体内，访问的时候轮流读这四个存储体。

## 6. 虚拟存储器

一、概念

1. 虚拟存储器：将主存或辅存的地址空间同一编址。
   ```
   虚拟内存的最大容量受主存和辅存的容量之和的限制。虚拟内存的实际容量受地址线的数量限制。


   或表示为 虚拟内存容量 = min(内存+外存， 地址线数量)
   ```
   
2. **逻辑地址、虚地址**：用户编程允许涉及的地址。虚地址对应的存储空间称为**虚拟空间或程序空间**。
3. **物理地址、实地址**：实际的存储单元地址。实地址对应**主存的地址空间**。

二、页式虚拟存储器

1. 定义：以页为基本单位。虚拟空间和物理空间都**被划分为相同大小的页**。主存的页称为**实页、页框**。虚存的页称为**虚页**。

2. 虚拟地址的构成：**[虚拟页号(高)][页内地址(低)]**。这里虚拟地址空间和物理地址空间应该是分开编址的？
   ```
   在页式虚拟存储器中，虚拟地址分为虚拟页号和页内地址两个部分。即[虚拟页号][页内地址]。
   ```
3. 转换：虚地址到实地址的转换由页表完成。**页表常驻内存**。
5. 页表：
   1. **页表项**由如下部分组成：**有效位(装入位)、脏位、引用位、存放位置**，各部分含义如下表：

         | 组成 | 有效位(装入位) | 脏位 | 引用位(使用位)   | 存放位置 |
         |:-----:|:------:|:-----:|:-----:|:----------------:|
         | 含义 | 虚拟页对应的物理页<br>是否在主存 | 该页是否被修改过 | 配合替换策略使用 | 如果不在内存则存放磁盘地址<br>否则存放该虚拟页对应的物理页号 |

   2. 转换过程：
      - 首先根据**页表基址寄存器**和**虚地址的虚拟页号部分**定位页表行。

      - 若不缺页，则将**页表项内的物理页号**和**虚地址的页内地址部分**拼接形成**物理地址**；
      - 否则（装入位为0），触发page fault，访问磁盘。
   3. 优点：页表长度固定、页表简单、调入方便。
   4. 缺点：页**并非逻辑上独立的实体**。处理、共享、保护不如段式存储器。页式管理**没有外碎片，有内碎片**。

6. 快表（TLB，后备转换缓冲器）：
   ```
   快表定义：由高速缓存中的页表项组成的页表称为快表。因此可知，快表位于cache中。
   ```
   1. 快表项由如下部分组成：**TLB标记字段、有效位、物理页号**，各部分含义如下表：

         |组成|TLB Tag(TLB标记)|有效位|物理页号|
         |:---:|:------:|:-----:|:--:|
         | 含义 | 如果是全相连，则Tag就是虚页号<br>如果为组相连，则Tag为虚页号的高位部分 | 对应虚拟页是否命中 | 整个页表项的内容（包括有效位等） |

   2. 特点：基于**局部性原理**、采用**全相连**或**组相连**方式。
   3. 地址转换：
      - 先对TLB查表。将虚拟页号拆分为**标记（Tag）和组索引**两个部分，即[虚拟页号][组索引]。

      - 首先由组索引确定在TLB的哪一组查找。
      - 将虚拟页号的**标记（Tag）部分和该组的TLB中的部分**比较，若相等且有效位为1，则命中。
      - 否则（都不相等），TLB缺失。访问主存去查页表。命中后还要更新页表。

三、段式存储器

1. 定义：段**按照程序的逻辑结构划分**，段长度因程序而异。

2. 虚拟地址的构成：**段号(高)和段内地址(低)**。
3. 转换：虚地址到实地址的转换由段表完成。段表常驻内存。
4. 段表：
   1. 构成：一个段表项有如下部分组成：**段首址、有效位(装入位)、段长**。各部分含义如下表：

         |组成|段首址|有效位(装入位)|段长|
         |:-:|:--:|:------:|:-------:|
         | 含义 | 该段在主存中的起始地址 | 该段是否存在主存 | 该段的长度，防止访问越界 |

   2. 转换过程： 
      - 首先根据**段基址寄存器**和**虚拟地址的段号部分**定位段表行。

      - 如果该段在主存，则将**段表内的段首址**和**虚拟地址的段内地址部分**拼接成物理地址。
      - 否则将缺失的段调入主存。
   1. 优点：段和程序段相对应，具有**逻辑独立性**，**易于编译、管理、修改、保护**。便于**多道程序的共享**。
   2. 缺点：段长度可变，不方便分配空间。段式管理**没有内碎片，有外碎片**。

   ```
   分段和分页的区别在于，分段对于程序员不透明，而分页对于程序员透明。
   ```

四、 段页式存储器

1. 描述：在段页式存储器中，程序按模块分段，段内再分页。用页表和段表进行二级管理。

2. 优缺点：兼顾了段式管理和页式管理的优点。缺点在于在地址映像过程中需要多次查表。